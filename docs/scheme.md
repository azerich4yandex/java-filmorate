# Таблицы приложения

## Общие примечания

* В качестве типа данных для идентификаторов записей в таблицах выбран общий тип `integer`, а способ генерации
  значений - через последовательности для реализации в `PostgreSQL` и через автоинкремент в `H2`.
* В качестве типа данных для хранения строки неограниченной длины выбран тип `text` для `PostgreSQL` и
  `CHARACTER VARYING` для `H2`
* В рамках нормализации данных для поля с рейтингом фильмов - создана сущность `Рейтинг`. В таблице фильмов хранится
  ссылка на выбранный рейтинг в отношении `один-к-одному` с возможностью последующего масштабирования до
  `один-ко-многим`, в случаях если будет необходимо использовать другие рейтинги.
* `Справедливо для H2` В ТЗ напрямую не указано поведение для внешних ключей при удалении данных из таблиц. В связи с
  этим выбрано поведение `ON DELETE SET NULL` для таблицы `RATINGS` и `ON DELETE CASCADE` для всех остальных
* В связи с тем, что слово `name` является зарезервированным в достаточном количестве RDBMS - все поля, которые должны
  содержать наименование представлены в таблицах как `full_name`
* Ограничения по заполненности и обязательности полей созданы на основе требований предыдущих ФЗ
* Для справочных таблиц созданы предварительные данные
* Для унификации при проектировании выбраны следующие правила именования сущностей:
    * Названия всех сущностей должны быть сформированы в едином регистре начертания символов. Для этого приложения
      выбран нижний регистр для `PostgreSQL` и верхний регистр для `H2`.
    * Названия таблиц должны отражать сущность, для которой созданы, на английском языке во множественном числе. Пример:
      `Пользователь` -> `User` -> `users`
    * Для внешних ключей (`foreign key`), имя должно содержать название таблицы, на которую поле ссылается(в
      единственном числе) и постфикс `_id`. Пример: `user_id` для ссылки на таблицу `users` по внешнему ключу
    * Для полей таблиц, которые содержат ограничения на уникальность (`unique constraints`), имя должно содержать
      название таблицы, суффикс `_unique_` и название поля, на которое накладывается ограничение по уникальности.
      Пример: `genres_unique_full_name` для ограничения уникальности на поле `full_name` в таблице `genres`
    * `Справедливо для PostgreSQL` Для последовательностей имя должно состоять из префикса `seq_` и названия таблицы.
      Пример: `seq_users`
    * Для первичных и составных ключей имя должно состоять из названия таблицы и постфикса `_pk`. Пример: `users_pk` для таблицы
      `users`.
    * Если в таблице присутствует внешний ключ на таблицу только от одного поля, то для внешних ключей имя должно
      состоять из:
        * названия текущей таблицы
        * названия таблицы, на которую ссылается внешний ключ
        * постфикса `_fk`

      Пример: `films_ratings_fk` для внешнего ключа от таблицы `films_rating` к таблице `ratings`

    * Если в таблице присутствуют несколько внешних ключей, ссылающихся на одну и ту же таблицу, то для внешних ключей
      имя должно состоять из:
        * названия текущей таблицы
        * названия таблицы, на которую ссылается внешний ключ
        * имени поля, которое ссылается на внешнюю таблицу
        * постфикса `_fk`

      Пример: `friends_users_user_id_fk` для первого внешнего ключа к таблице `users` и `friends_users_other_id_fk` для
      второго внешнего ключа к той же таблице

    * Для ограничений значений (`constraint check`) имя должно содержать название таблицы, имя поля/полей, на которое
      ограничение распространяется и суффикс `_chk`. Пример: `films_duration_chk` для ограничения значений поля
      `duration` в таблице `films`
* Создание индексов на текущем этапе развития приложения не предусмотрено, так как большая часть запросов будет покрыта
  первичными и внешними ключами.

## Таблицы

### `ratings` - справочная таблица рейтингов

| Поле      | Тип данных | Обязательность | Описание             |
|-----------|------------|----------------|----------------------|
| id        | integer    | Да             | Идентификатор записи |
| full_name | text       | Да             | Имя                  |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_ratings`
* Таблица содержит первичный ключ `ratings_pk`
* Таблица содержит ограничение `ratings_unique_full_name`, чтобы обеспечить уникальность наименований рейтингов

Предварительные справочные данные:

| id | full_name |
|----|-----------|
| 1  | G         |
| 2  | PG        |
| 3  | PG-13     |
| 4  | R         |
| 5  | NC-17     |

### `films` - таблица фильмов

| Поле         | Тип данных   | Обязательность | Описание              |
|--------------|--------------|----------------|-----------------------|
| id           | integer      | Да             | Идентификатор записи  |
| full_name    | text         | Да             | Имя                   |
| description  | varchar(200) | Да             |                       |
| release_date | date         | Нет            | Дата релиза           |
| duration     | integer      | Нет            | Длительность          |
| rating_id    | integer      | Нет            | Ссылка на рейтинг MPA |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_films`
* Таблица содержит первичный ключ `films_genres_pk`
* Таблица содержит внешний ключ `films_ratings_fk` на таблицу `ratings`
* Таблица содержит ограничение `films_duration_chk` на положительное значение поля duration.

### `genres` - справочная таблица жанров

| Поле      | Тип данных | Обязательность | Описание             |
|-----------|------------|----------------|----------------------|
| id        | integer    | Да             | Идентификатор записи |
| full_name | text       | Да             | Имя                  |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_genres`
* Таблица содержит первичный ключ `genres_pk`
* Таблица содержит ограничение `genres_unique_full_name`, чтобы обеспечить уникальность наименований жанров

Предварительные данные:

| id | full_name      |
|----|----------------|
| 1  | Комедия        |
| 2  | Драма          |
| 3  | Мультфильм     |
| 4  | Триллер        |
| 5  | Документальный |
| 6  | Боевик         |

### `films_genres` - таблица связей между фильмами и жанрами

| Поле     | Тип данных | Обязательность | Описание                       |
|----------|------------|----------------|--------------------------------|
| film_id  | integer    | Да             | Ссылка на идентификатор фильма |
| genre_id | integer    | Да             | Ссылка на идентификатор жанра  |

Примечания:


* Таблица содержит первичный ключ `films_genres_pk`
* Таблица содержит внешний ключ `films_genres_films_fk` на таблицу `films`
* Таблица содержит внешний ключ `films_genres_genres_fk` на таблицу `genres`

### `users` - таблица пользователей

| Поле      | Тип данных   | Обязательность | Описание                |
|-----------|--------------|----------------|-------------------------|
| id        | integer      | Да             | Идентификатор записи    |
| email     | varchar(254) | Да             | Адрес электронной почты |
| login     | varchar(254) | Да             | Логин                   |
| full_name | text         | Нет            | Имя                     |
| birthday  | date         | Да             | Дата рождения           |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_users`
* Таблица содержит первичный ключ `users_pk`
* Таблица содержит ограничение `users_unique_email`
* Таблица содержит ограничение `users_unique_login`
* Ограничение для длинны поля `email` предусмотрено с учётом ограничения максимальной длинны адреса электронной
  почты ([RFC-5321](https://datatracker.ietf.org/doc/html/rfc5321))
* Ограничение длинны поля `login` сделано по аналогии с `email` без ссылок на стандарты.

### `users_films` - таблица связей между пользователями и фильмами

| Поле    | Тип данных | Обязательность | Описание                   |
|---------|------------|----------------|----------------------------|
| user_id | integer    | Да             | Идентификатор пользователя |
| film_id | integer    | Да             | Идентификатор фильма       |

Примечания:

* Таблица содержит первичный ключ `users_films_pk`
* Таблица содержит внешний ключ `users_films_films_fk` на таблицу `films`
* Таблица содержит внешний ключ `users_films_users_fk` на таблицу `users`

### `friends` - таблица связей межу пользователями

| Поле     | Тип данных | Обязательность | Описание                             |
|----------|------------|----------------|--------------------------------------|
| user_id  | integer    | Да             | Идентификатор пользователя-заявителя |
| other_id | integer    | Да             | Идентификатор пользователя-адресата  |

Примечания:

* Таблица содержит первичный ключ `friends_pk`
* Таблица содержит внешний ключ `friends_users_other_id_fk` на таблицу `users`
* Таблица содержит внешний ключ `friends_users_user_id_fk` на таблицу `users`

### `reviews` - таблица отзывов

| Поле        | Тип данных | Обязательность | Описание                                         |
|-------------|------------|----------------|--------------------------------------------------|
| id          | integer    | Да             | Идентификатор записи                             |
| user_id     | integer    | Да             | Идентификатор пользователя-автора                |
| film_id     | integer    | Да             | Идентификатор фильма, на который оставляют отзыв |
| content     | text       | Да             | Описание отзыва                                  |
| is_positive | boolean    | Нет            | Признак положительного отзыва                    |

* Таблица содержит первичный ключ `reviews_fk`
* Таблица содержит внешний ключ `users_reviews_user_id_fk` на таблицу `users`
* Таблица содержит внешний ключ `films_reviews_film_id_fk` на таблицу `films`

### `users_reviews` - таблица оценки отзывов пользователями

| Поле      | Тип данных | Обязательность | Описание                    |
|-----------|------------|----------------|-----------------------------|
| review_id | integer    | Да             | Идентификатор отзыва        |
| user_id   | integer    | Да             | Идентификатор пользователя  |
| useful    | integer    | Да             | Оценка отзыва пользователем |

* Таблица содержит первичный ключ `users_reviews_pk`
* Таблица содержит внешний ключ `users_reviews_reviews_review_id_fk` на таблицу `reviews`
* Таблица содержит внешний ключ `users_reviews_users_user_id_fk` на таблицу `users`
* Таблица содержит ограничение `users_reviews_useful_chk` на поле `useful`

### `directors` - таблица режиссеров

| Поле      | Тип данных | Обязательность | Описание                |
|-----------|------------|----------------|-------------------------|
| id        | integer    | Да             | Идентификатор режиссера |
| full_name | text       | Да             | Имя режиссера           |

* Таблица содержит первичный ключ `directors_pk`

### `films_directors` - таблица связи фильмов с режиссерами

| Поле        | Тип данных | Обязательность | Описание                |
|-------------|------------|----------------|-------------------------|
| film_id     | integer    | Да             | Идентификатор фильма    |
| director_id | integer    | Да             | Идентификатор режиссера |

* Таблица содержит первичный ключ `films_directors_pk`
* Таблица содержит внешний ключ `films_directors_films_film_id_fk` на таблицу `films`
* Таблица содержит внешний ключ `films_directors_directors_director_id_fk` на таблицу `directors`
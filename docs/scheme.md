# Таблицы приложения

## Общие примечания

* В качестве типа данных для идентификаторов записей в таблицах выбран общий тип `INTEGER`, а способ генерации
  значений - через последовательности для реализации в `PostgreSQL` и через автоинкремент в `H2`.
  Для этого были созданы последовательности для каждой таблицы, и поля `id` для идентификации записей.
  В таблицах связей поле идентификатора используется для последующего логирования операций.
* Для последующего масштабирования дружба между пользователями вынесена как связь между пользователями и определённым
  видом отношений:
    * `Пользователь` - `Отношение` - `Пользователь`

  где сущность `Отношение` уже дополнена полями `Статус` и `Тип`.
* В рамках нормализации данных для полей `Статус` и `Тип` так же созданы отдельные сущности в качестве справочников
* Тот же подход выбран при проектировании поля с рейтингом фильмов - создана сущность `Рейтинг`. В таблице фильмов
  хранится ссылка на выбранный рейтинг в отношении `один-к-одному` с возможностью последующего масштабирования до
  `один-ко-многим`, в случаях если будет необходимо использовать другие рейтинги.
* В связи с тем, что слово `name` является зарезервированным в больш**о**м количестве RDBMS - все поля, которые должны
  содержать наименование представлены в таблицах как `full_name`
* Ограничения по заполненности и обязательности полей созданы на основе требований предыдущих ФЗ
* Для справочных таблиц созданы предварительные данные
* Для унификации при проектировании выбраны следующие правила именования сущностей:
    * Названия всех сущностей должны быть сформированы в едином регистре начертания символов. Для этого приложения
      выбран нижний регистр.
    * Названия таблиц должны отражать сущность, для которой созданы, на английском языке во множественном числе. Пример:
      `Пользователь` -> `User` -> `users`
    * Для внешних ключей (`foreign key`), имя должно содержать название таблицы, на которую поле ссылается(в
      единственном числе) и постфикс `_id`. Пример: `user_id` для ссылки на таблицу `users` по внешнему ключу
    * Для полей таблиц, которые содержат ограничения на уникальность (`unique constraints`), имя должно содержать
      название таблицы, суффикс `_unique_` и название поля, на которое накладывается ограничение по уникальности.
      Пример: `genres_unique_full_name` для ограничения уникальности на поле `full_name` в таблице `genres`
    * `Справедливо только для PostgreSQL` Для последовательностей имя должно состоять из префикса `seq_` и названия
      таблицы. Пример: `seq_users`
    * Для первичных ключей имя должно состоять из названия таблицы и постфикса `_pk`. Пример: `users_pk` для таблицы
      `users`.
    * Для внешних ключей имя должно состоять из названия текущей таблицы, названия таблицы, на которую ссылается внешний
      ключ и постфикса `_fk`. Пример: `films_ratings_fk` для внешнего ключа от таблицы `films_rating` к таблице
      `ratings`
    * Для ограничений значений (`constraint check`) имя должно содержать название таблицы, имя поля/полей, на которое
      ограничение распространяется и суффикс `_chk`. Пример: `films_duration_chk` для ограничения значений поля
      `duration` в таблице `films`
* Создание индексов на текущем этапе развития приложения не предусмотрено, так как большая часть запросов будет покрыта
  первичными и внешними ключами.

## Таблицы

### `ratings` - справочная таблица рейтингов

| Поле      | Тип данных | Обязательность | Описание             |
|-----------|------------|----------------|----------------------|
| id        | integer    | Да             | Идентификатор записи |
| full_name | text       | Да             | Имя                  |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_ratings`
* Таблица содержит первичный ключ `ratings_pk`
* Таблица содержит ограничение `ratings_unique_full_name`

Предварительные справочные данные:

| id | full_name |
|----|-----------|
| 1  | G         |
| 2  | PG        |
| 3  | PG-13     |
| 4  | R         |
| 5  | NC-17     |

### `films` - таблица фильмов

| Поле         | Тип данных   | Обязательность | Описание              |
|--------------|--------------|----------------|-----------------------|
| id           | integer      | Да             | Идентификатор записи  |
| full_name    | text         | Да             | Имя                   |
| description  | varchar(200) | Да             |                       |
| release_date | date         | Нет            | Дата релиза           |
| duration     | integer      | Нет            | Длительность          |
| rating_id    | integer      | Нет            | Ссылка на рейтинг MPA |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_films`
* Таблица содержит первичный ключ `films_genres_pk`
* Таблица содержит внешний ключ `films_ratings_fk` на таблицу `ratings`
* В ходе разработки приложения на предыдущих этапах ограничений на длину поля `full_name` наложено не было. В связи с
  этим выбран тип поля для неограниченного размера строки.

### `genres` - справочная таблица жанров

| Поле      | Тип данных | Обязательность | Описание             |
|-----------|------------|----------------|----------------------|
| id        | integer    | Да             | Идентификатор записи |
| full_name | text       | Да             | Имя                  |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_genres`
* Таблица содержит первичный ключ `genres_pk`
* Таблица содержит ограничение `genres_unique_full_name`

Предварительные данные:

| id | full_name      |
|----|----------------|
| 1  | Комедия        |
| 2  | Драма          |
| 3  | Мультфильм     |
| 4  | Триллер        |
| 5  | Документальный |
| 6  | Боевик         |

### `films_genres` - таблица связей между фильмами и жанрами

| Поле     | Тип данных | Обязательность | Описание                       |
|----------|------------|----------------|--------------------------------|
| id       | integer    | Да             | Идентификатор записи           |
| film_id  | integer    | Да             | Ссылка на идентификатор фильма |
| genre_id | integer    | Да             | Ссылка на идентификатор жанра  |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_films_genres`
* Таблица содержит первичный ключ `films_genres_pk`
* Таблица содержит ограничение `films_genres_unique_films_id_genre_id`, чтобы у одного фильма не было одинаковых жанров
* Таблица содержит внешний ключ `films_genres_films_fk` на таблицу `films`
* Таблица содержит внешний ключ `films_genres_genres_fk` на таблицу `genres`

### `users` - таблица пользователей

| Поле      | Тип данных   | Обязательность | Описание                |
|-----------|--------------|----------------|-------------------------|
| id        | integer      | Да             | Идентификатор записи    |
| email     | varchar(254) | Да             | Адрес электронной почты |
| login     | varchar(254) | Да             | Логин                   |
| full_name | text         | Нет            | Имя                     |
| birthday  | date         | Да             | Дата рождения           |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_users`
* Таблица содержит первичный ключ `users_pk`
* Таблица содержит ограничение `users_unique_email`
* Таблица содержит ограничение `users_unique_login`
* Ограничение для длинны поля `email` предусмотрено с учётом ограничения максимальной длинны адреса электронной
  почты ([RFC-5321](https://datatracker.ietf.org/doc/html/rfc5321))
* Ограничение длинны поля `login` сделано по аналогии с `email` без ссылок на стандарты.
* В ходе разработки приложения на предыдущих этапах ограничений на длину поля `full_name` наложено не было. В связи с
  этим выбран тип поля для неограниченного размера строки.

### `users_films` - таблица связей между пользователями и фильмами

| Поле    | Тип данных | Обязательность | Описание                   |
|---------|------------|----------------|----------------------------|
| id      | integer    | Да             | Идентификатор записи       |
| user_id | integer    | Да             | Идентификатор пользователя |
| film_id | integer    | Да             | Идентификатор фильма       |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_users_films`
* Таблица содержит первичный ключ `users_films_pk`
* Таблица содержит внешний ключ `users_films_films_fk` на таблицу `films`
* Таблица содержит внешний ключ `users_films_users_fk` на таблицу `users`
* Таблица содержит ограничение `users_films_unique_user_id_film_id`

### `relationship_attributes` - само-ссылающийся справочник для указания характеристик отношений

| Поле           | Тип данных | Обязательность | Описание                    |
|----------------|------------|----------------|-----------------------------|
| id             | integer    | Да             | Идентификатор записи        |
| attribute_type | integer    | Нет            | Тип атрибута отношений      |
| full_name      | text       | Да             | Значение атрибута отношений |

Примечания

* Для генерации идентификаторов используется последовательность `seq_relationship_attributes`
* Таблица содержит первичный ключ `relationship_attributes_pk`
* Таблица содержит внешний ключ `relationship_attributes` на саму себя
* Таблица содержит ограничение `relationship_attributes_unique_attribute_type_full_name`

Предварительные данные:

| ID  | ATTRIBUTE_TYPE | FULL_NAME             |
|-----|----------------|-----------------------|
| 1   | null           | Справочники атрибутов |
| 2   | 1              | Типы отношений        |
| 3   | 1              | Статусы отношений     |
| 4   | 2              | Дружба                |
| 5   | 2              | Вражда                |
| 6   | 2              | Семья                 |
| 7   | 2              | Любовь                |
| 8   | 3              | Запрошено             |
| 9   | 3              | Одобрено              |
| 10  | 3              | Отклонено             |

### `relationships` - таблица отношений

| Поле      | Тип данных | Обязательность | Описание                                  |
|-----------|------------|----------------|-------------------------------------------|
| id        | integer    | Да             | Идентификатор записи                      |
| type_id   | integer    | Да             | Ссылка на идентификатор типа отношений    |
| status_id | integer    | Да             | Ссылка на идентификатор статуса отношений |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_relationships`
* Таблица содержит первичный ключ `relationships_pk`
* Таблица содержит внешний ключ `relationships_relationship_attributes_status_fk` на таблицу `relationship_attributes`
* Таблица содержит внешний ключ `relationships_relationship_attributes_type_fk` на таблицу `relationship_attributes`

### `users_relationships` - таблица связей пользователей с отношениями

| Поле            | Тип данных | Обязательность | Описание                             |
|-----------------|------------|----------------|--------------------------------------|
| id              | integer    | Да             | Идентификатор записи                 |
| user_id         | integer    | Да             | Ссылка на идентификатор пользователя |
| relationship_id | integer    | Да             | Ссылка на идентификатор отношений    |

Примечания:

* Для генерации идентификаторов используется последовательность `seq_users_relationships`
* Таблица содержит первичный ключ `users_relationships_pk`
* Таблица содержит внешний ключ `users_relationships_relationships_fk` на таблицу `relationships`
* Таблица содержит внешний ключ `users_relationships_users_fk` на таблицу `users_pk`
* Таблица содержит ограничение `users_relationships_unique_user_id_relationship_id`